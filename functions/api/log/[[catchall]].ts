import { HttpError } from '../../HttpError'
import { SizedMap } from '../../SizedMap'
import { refreshUrls } from '../../refreshUrls'

interface Env {
  BOT_TOKEN: string
}

const MISSING_PATH_PARAM = JSON.stringify({
  error: 'channelId, attachmentId, and fileName required',
})

const headers: HeadersInit = {
  'content-type': 'application/json',
}

export const onRequest: PagesFunction<Env> = async (context) => {
  const [channelId, attachmentId, fileName] = context.params
    .catchall as string[]

  console.log(channelId, attachmentId, fileName)

  if (!channelId || !attachmentId || !fileName) {
    return new Response(MISSING_PATH_PARAM, {
      status: 400,
      headers,
    })
  }

  try {
    const messages = await fetchMessages(
      { channelId, attachmentId, fileName },
      context.env.BOT_TOKEN,
    )

    return new Response(messages, {
      headers,
    })
  } catch (err) {
    const error = err instanceof Error ? err.message : String(err)
    const status = err instanceof HttpError ? err.status : 500

    return new Response(JSON.stringify({ error }), {
      status,
      headers,
    })
  }
}

interface AttachmentParams {
  channelId: string
  attachmentId: string
  fileName: string
}

function toDiscordAttachmentUrl({
  channelId,
  attachmentId,
  fileName,
}: AttachmentParams) {
  return `https://cdn.discordapp.com/attachments/${channelId}/${attachmentId}/${fileName}`
}

const discordCache = new SizedMap<string, string>(100)

async function fetchMessages(
  attachmentParams: AttachmentParams,
  token: string,
): Promise<string> {
  const url = toDiscordAttachmentUrl(attachmentParams)

  if (discordCache.has(url)) {
    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
    return discordCache.get(url)!
  }

  const { refreshed } = (await refreshUrls([url], token))[0]

  const response = await fetch(refreshed, {
    headers: {
      Authorization: `Bot ${token}`,
    },
  })

  if (!response.ok) {
    switch (response.status) {
      case 404:
        throw new HttpError(response.status, 'Attachment not found')
      case 403:
        throw new HttpError(response.status, 'Forbidden to fetch attachment')
      case 429:
        throw new HttpError(response.status, 'Rate limited')
      default:
        throw new HttpError(response.status, 'Failed to fetch attachment')
    }
  }

  const log = await response.text()
  discordCache.set(url, log)
  return log
}

// const messages = [
//   {
//     type: 0,
//     tts: false,
//     timestamp: '2024-05-15T09:52:48.848000+00:00',
//     referenced_message: null,
//     pinned: false,
//     nonce: '1240240457141714944',
//     mentions: [],
//     mention_roles: [],
//     mention_everyone: false,
//     member: {
//       roles: [
//         '343304760335794177',
//         '212076668259532802',
//         '632306904466456592',
//         '524137689184862229',
//         '679862541186629659',
//       ],
//       premium_since: '2021-06-25T17:02:05.510000+00:00',
//       pending: false,
//       nick: null,
//       mute: false,
//       joined_at: '2016-08-07T21:20:16.396000+00:00',
//       flags: 2,
//       deaf: false,
//       communication_disabled_until: null,
//       avatar: null,
//       user: {
//         id: '74768773940256768',
//         bot: false,
//         system: false,
//         flags: 4588160,
//         username: 'atorasuunva',
//         globalName: 'Atora',
//         discriminator: '0',
//         avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//         banner: 'a_9bd15695e8512e33cd11bfd2dc321c47',
//         accentColor: 13810863,
//         avatarDecoration: null,
//         createdTimestamp: 1437896664844,
//         defaultAvatarURL: 'https://cdn.discordapp.com/embed/avatars/4.png',
//         hexAccentColor: '#d2bcaf',
//         tag: 'atorasuunva',
//         avatarURL:
//           'https://cdn.discordapp.com/avatars/74768773940256768/614b3c8468048f74b4d95d09d30f0c3f.webp',
//         displayAvatarURL:
//           'https://cdn.discordapp.com/avatars/74768773940256768/614b3c8468048f74b4d95d09d30f0c3f.webp',
//         bannerURL:
//           'https://cdn.discordapp.com/banners/74768773940256768/a_9bd15695e8512e33cd11bfd2dc321c47.gif',
//       },
//     },
//     id: '1240240462644777000',
//     flags: 0,
//     embeds: [],
//     edited_timestamp: null,
//     content: '1',
//     components: [],
//     channel_id: '861845554732859404',
//     author: {
//       username: 'atorasuunva',
//       public_flags: 4588160,
//       id: '74768773940256768',
//       global_name: 'Atora',
//       discriminator: '0',
//       clan: null,
//       avatar_decoration_data: null,
//       avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//     },
//     attachments: [],
//     guild_id: '211956704798048256',
//   },
//   {
//     type: 0,
//     tts: false,
//     timestamp: '2024-05-15T09:52:49.623000+00:00',
//     referenced_message: null,
//     pinned: false,
//     nonce: '1240240460367134720',
//     mentions: [],
//     mention_roles: [],
//     mention_everyone: false,
//     member: {
//       roles: [
//         '343304760335794177',
//         '212076668259532802',
//         '632306904466456592',
//         '524137689184862229',
//         '679862541186629659',
//       ],
//       premium_since: '2021-06-25T17:02:05.510000+00:00',
//       pending: false,
//       nick: null,
//       mute: false,
//       joined_at: '2016-08-07T21:20:16.396000+00:00',
//       flags: 2,
//       deaf: false,
//       communication_disabled_until: null,
//       avatar: null,
//     },
//     id: '1240240465895231498',
//     flags: 0,
//     embeds: [],
//     edited_timestamp: null,
//     content: '2',
//     components: [],
//     channel_id: '861845554732859404',
//     author: {
//       username: 'atorasuunva',
//       public_flags: 4588160,
//       id: '74768773940256768',
//       global_name: 'Atora',
//       discriminator: '0',
//       clan: null,
//       avatar_decoration_data: null,
//       avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//     },
//     attachments: [],
//     guild_id: '211956704798048256',
//   },
//   {
//     type: 0,
//     tts: false,
//     timestamp: '2024-05-15T09:52:49.871000+00:00',
//     referenced_message: null,
//     pinned: false,
//     nonce: '1240240461398933504',
//     mentions: [],
//     mention_roles: [],
//     mention_everyone: false,
//     member: {
//       roles: [
//         '343304760335794177',
//         '212076668259532802',
//         '632306904466456592',
//         '524137689184862229',
//         '679862541186629659',
//       ],
//       premium_since: '2021-06-25T17:02:05.510000+00:00',
//       pending: false,
//       nick: null,
//       mute: false,
//       joined_at: '2016-08-07T21:20:16.396000+00:00',
//       flags: 2,
//       deaf: false,
//       communication_disabled_until: null,
//       avatar: null,
//     },
//     id: '1240240466935545906',
//     flags: 0,
//     embeds: [],
//     edited_timestamp: null,
//     content: '3',
//     components: [],
//     channel_id: '861845554732859404',
//     author: {
//       username: 'atorasuunva',
//       public_flags: 4588160,
//       id: '74768773940256768',
//       global_name: 'Atora',
//       discriminator: '0',
//       clan: null,
//       avatar_decoration_data: null,
//       avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//     },
//     attachments: [],
//     guild_id: '211956704798048256',
//   },
//   {
//     type: 0,
//     tts: false,
//     timestamp: '2024-05-15T09:52:50.107000+00:00',
//     referenced_message: null,
//     pinned: false,
//     nonce: '1240240462472675328',
//     mentions: [],
//     mention_roles: [],
//     mention_everyone: false,
//     member: {
//       roles: [
//         '343304760335794177',
//         '212076668259532802',
//         '632306904466456592',
//         '524137689184862229',
//         '679862541186629659',
//       ],
//       premium_since: '2021-06-25T17:02:05.510000+00:00',
//       pending: false,
//       nick: null,
//       mute: false,
//       joined_at: '2016-08-07T21:20:16.396000+00:00',
//       flags: 2,
//       deaf: false,
//       communication_disabled_until: null,
//       avatar: null,
//     },
//     id: '1240240467925270640',
//     flags: 0,
//     embeds: [],
//     edited_timestamp: null,
//     content: '4',
//     components: [],
//     channel_id: '861845554732859404',
//     author: {
//       username: 'atorasuunva',
//       public_flags: 4588160,
//       id: '74768773940256768',
//       global_name: 'Atora',
//       discriminator: '0',
//       clan: null,
//       avatar_decoration_data: null,
//       avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//     },
//     attachments: [],
//     guild_id: '211956704798048256',
//   },
//   {
//     type: 0,
//     tts: false,
//     timestamp: '2024-05-15T09:52:50.739000+00:00',
//     referenced_message: null,
//     pinned: false,
//     nonce: '1240240465068949504',
//     mentions: [],
//     mention_roles: [],
//     mention_everyone: false,
//     member: {
//       roles: [
//         '343304760335794177',
//         '212076668259532802',
//         '632306904466456592',
//         '524137689184862229',
//         '679862541186629659',
//       ],
//       premium_since: '2021-06-25T17:02:05.510000+00:00',
//       pending: false,
//       nick: null,
//       mute: false,
//       joined_at: '2016-08-07T21:20:16.396000+00:00',
//       flags: 2,
//       deaf: false,
//       communication_disabled_until: null,
//       avatar: null,
//     },
//     id: '1240240470576336906',
//     flags: 0,
//     embeds: [],
//     edited_timestamp: null,
//     content: '5',
//     components: [],
//     channel_id: '861845554732859404',
//     author: {
//       username: 'atorasuunva',
//       public_flags: 4588160,
//       id: '74768773940256768',
//       global_name: 'Atora',
//       discriminator: '0',
//       clan: null,
//       avatar_decoration_data: null,
//       avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//     },
//     attachments: [],
//     guild_id: '211956704798048256',
//   },
//   {
//     webhook_id: '290952033522155521',
//     type: 20,
//     tts: false,
//     timestamp: '2024-05-15T09:52:53.234000+00:00',
//     position: 0,
//     pinned: false,
//     nonce: '1240240474707460096',
//     mentions: [],
//     mention_roles: [],
//     mention_everyone: false,
//     member: {
//       roles: ['332418988493766656', '679862541186629659', '355532772854464525'],
//       premium_since: null,
//       pending: false,
//       nick: null,
//       mute: false,
//       joined_at: '2017-12-05T01:37:41.375000+00:00',
//       flags: 0,
//       deaf: false,
//       communication_disabled_until: null,
//       avatar: null,
//     },
//     interaction_metadata: {
//       user_id: '74768773940256768',
//       user: {
//         username: 'atorasuunva',
//         public_flags: 4588160,
//         id: '74768773940256768',
//         global_name: 'Atora',
//         discriminator: '0',
//         clan: null,
//         avatar_decoration_data: null,
//         avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//       },
//       type: 2,
//       name: 'info',
//       id: '1240240480369770496',
//       authorizing_integration_owners: { '0': '211956704798048256' },
//     },
//     interaction: {
//       user: {
//         username: 'atorasuunva',
//         public_flags: 4588160,
//         id: '74768773940256768',
//         global_name: 'Atora',
//         discriminator: '0',
//         clan: null,
//         avatar_decoration_data: null,
//         avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//       },
//       type: 2,
//       name: 'info',
//       member: {
//         roles: [
//           '343304760335794177',
//           '212076668259532802',
//           '632306904466456592',
//           '524137689184862229',
//           '679862541186629659',
//         ],
//         premium_since: '2021-06-25T17:02:05.510000+00:00',
//         pending: false,
//         nick: null,
//         mute: false,
//         joined_at: '2016-08-07T21:20:16.396000+00:00',
//         flags: 2,
//         deaf: false,
//         communication_disabled_until: null,
//         avatar: null,
//       },
//       id: '1240240480369770496',
//     },
//     id: '1240240481040990278',
//     flags: 0,
//     embeds: [
//       {
//         type: 'rich',
//         thumbnail: {
//           width: 128,
//           url: 'https://cdn.discordapp.com/avatars/290952033522155521/000ad18e8e53f27771f6759dd72f5695.webp',
//           proxy_url:
//             'https://images-ext-1.discordapp.net/external/MUuQ1AyqFPJnlCcQsUwdh9VAWQPC6-J5gFtCwyIArM8/https/cdn.discordapp.com/avatars/290952033522155521/000ad18e8e53f27771f6759dd72f5695.webp',
//           height: 128,
//         },
//         fields: [
//           {
//             value: 'Atora‎ [**atorasuunva**‎] (74768773940256768)',
//             name: 'Owner',
//             inline: true,
//           },
//           {
//             value: 'Node v20.10.0\ndiscord.js v14.15.2',
//             name: 'Using',
//             inline: true,
//           },
//           {
//             value: '1m: 0.61%, 5m: 0.48%, 15m: 0.64%',
//             name: 'CPU Load Average',
//             inline: false,
//           },
//           {
//             value: '9.702 GB / 16.727 GB (58.00%)',
//             name: 'Memory Usage',
//             inline: true,
//           },
//           { value: 'Unknown', name: 'Bot Guild', inline: true },
//           { value: '3', name: 'Approximate Guilds', inline: true },
//         ],
//         author: { name: 'Yarnak‎#6142 (290952033522155521)' },
//       },
//     ],
//     edited_timestamp: null,
//     content: '',
//     components: [],
//     channel_id: '861845554732859404',
//     author: {
//       username: 'Yarnak',
//       public_flags: 0,
//       id: '290952033522155521',
//       global_name: null,
//       discriminator: '6142',
//       clan: null,
//       bot: true,
//       avatar_decoration_data: null,
//       avatar: '000ad18e8e53f27771f6759dd72f5695',
//     },
//     attachments: [],
//     application_id: '290952033522155521',
//     guild_id: '211956704798048256',
//   },
//   {
//     type: 0,
//     tts: false,
//     timestamp: '2024-05-15T09:52:54.917000+00:00',
//     referenced_message: null,
//     pinned: false,
//     nonce: '1240240482601140224',
//     mentions: [],
//     mention_roles: [],
//     mention_everyone: false,
//     member: {
//       roles: [
//         '343304760335794177',
//         '212076668259532802',
//         '632306904466456592',
//         '524137689184862229',
//         '679862541186629659',
//       ],
//       premium_since: '2021-06-25T17:02:05.510000+00:00',
//       pending: false,
//       nick: null,
//       mute: false,
//       joined_at: '2016-08-07T21:20:16.396000+00:00',
//       flags: 2,
//       deaf: false,
//       communication_disabled_until: null,
//       avatar: null,
//     },
//     id: '1240240488099872769',
//     flags: 0,
//     embeds: [],
//     edited_timestamp: null,
//     content: 's?say hi',
//     components: [],
//     channel_id: '861845554732859404',
//     author: {
//       username: 'atorasuunva',
//       public_flags: 4588160,
//       id: '74768773940256768',
//       global_name: 'Atora',
//       discriminator: '0',
//       clan: null,
//       avatar_decoration_data: null,
//       avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//     },
//     attachments: [],
//     guild_id: '211956704798048256',
//   },
//   {
//     type: 0,
//     tts: false,
//     timestamp: '2024-05-15T09:52:55.014000+00:00',
//     referenced_message: null,
//     pinned: false,
//     mentions: [],
//     mention_roles: [],
//     mention_everyone: false,
//     member: {
//       roles: ['332418988493766656', '679862541186629659', '355532772854464525'],
//       premium_since: null,
//       pending: false,
//       nick: null,
//       mute: false,
//       joined_at: '2016-10-09T16:57:15.392000+00:00',
//       flags: 0,
//       deaf: false,
//       communication_disabled_until: null,
//       avatar: null,
//       user: {
//         id: '205164225625194496',
//         bot: true,
//         system: false,
//         flags: 0,
//         username: 'Smol Bot',
//         globalName: null,
//         discriminator: '6975',
//         avatar: 'd047557e134ba3f50e4a3dd094484188',
//         avatarDecoration: null,
//         createdTimestamp: 1468985363156,
//         defaultAvatarURL: 'https://cdn.discordapp.com/embed/avatars/0.png',
//         tag: 'Smol Bot#6975',
//         avatarURL:
//           'https://cdn.discordapp.com/avatars/205164225625194496/d047557e134ba3f50e4a3dd094484188.webp',
//         displayAvatarURL:
//           'https://cdn.discordapp.com/avatars/205164225625194496/d047557e134ba3f50e4a3dd094484188.webp',
//       },
//     },
//     id: '1240240488506855497',
//     flags: 0,
//     embeds: [],
//     edited_timestamp: null,
//     content: 'hi',
//     components: [],
//     channel_id: '861845554732859404',
//     author: {
//       username: 'Smol Bot',
//       public_flags: 0,
//       id: '205164225625194496',
//       global_name: null,
//       discriminator: '6975',
//       clan: null,
//       bot: true,
//       avatar_decoration_data: null,
//       avatar: 'd047557e134ba3f50e4a3dd094484188',
//     },
//     attachments: [],
//     guild_id: '211956704798048256',
//   },
//   {
//     type: 0,
//     tts: false,
//     timestamp: '2024-05-15T09:52:55.224000+00:00',
//     referenced_message: null,
//     pinned: false,
//     mentions: [],
//     mention_roles: [],
//     mention_everyone: false,
//     member: {
//       roles: ['332418988493766656', '679862541186629659', '355532772854464525'],
//       premium_since: null,
//       pending: false,
//       nick: null,
//       mute: false,
//       joined_at: '2016-10-09T16:57:15.392000+00:00',
//       flags: 0,
//       deaf: false,
//       communication_disabled_until: null,
//       avatar: null,
//     },
//     id: '1240240489387528192',
//     flags: 0,
//     embeds: [],
//     edited_timestamp: null,
//     content: 'atorasuunva: Sent "hi" to <#861845554732859404>',
//     components: [],
//     channel_id: '861845554732859404',
//     author: {
//       username: 'Smol Bot',
//       public_flags: 0,
//       id: '205164225625194496',
//       global_name: null,
//       discriminator: '6975',
//       clan: null,
//       bot: true,
//       avatar_decoration_data: null,
//       avatar: 'd047557e134ba3f50e4a3dd094484188',
//     },
//     attachments: [],
//     guild_id: '211956704798048256',
//   },
//   {
//     type: 19,
//     tts: false,
//     timestamp: '2024-05-15T09:53:03.274000+00:00',
//     referenced_message: {
//       type: 0,
//       tts: false,
//       timestamp: '2024-05-15T09:52:50.739000+00:00',
//       pinned: false,
//       mentions: [],
//       mention_roles: [],
//       mention_everyone: false,
//       id: '1240240470576336906',
//       flags: 0,
//       embeds: [],
//       edited_timestamp: null,
//       content: '5',
//       components: [],
//       channel_id: '861845554732859404',
//       author: {
//         username: 'atorasuunva',
//         public_flags: 4588160,
//         id: '74768773940256768',
//         global_name: 'Atora',
//         discriminator: '0',
//         clan: null,
//         avatar_decoration_data: null,
//         avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//       },
//       attachments: [],
//     },
//     pinned: false,
//     nonce: '1240240517602607104',
//     message_reference: {
//       type: 0,
//       message_id: '1240240470576336906',
//       guild_id: '211956704798048256',
//       channel_id: '861845554732859404',
//     },
//     mentions: [],
//     mention_roles: [],
//     mention_everyone: false,
//     member: {
//       roles: [
//         '343304760335794177',
//         '212076668259532802',
//         '632306904466456592',
//         '524137689184862229',
//         '679862541186629659',
//       ],
//       premium_since: '2021-06-25T17:02:05.510000+00:00',
//       pending: false,
//       nick: null,
//       mute: false,
//       joined_at: '2016-08-07T21:20:16.396000+00:00',
//       flags: 2,
//       deaf: false,
//       communication_disabled_until: null,
//       avatar: null,
//     },
//     id: '1240240523151937536',
//     flags: 0,
//     embeds: [],
//     edited_timestamp: null,
//     content: 'replying to 5',
//     components: [],
//     channel_id: '861845554732859404',
//     author: {
//       username: 'atorasuunva',
//       public_flags: 4588160,
//       id: '74768773940256768',
//       global_name: 'Atora',
//       discriminator: '0',
//       clan: null,
//       avatar_decoration_data: null,
//       avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//     },
//     attachments: [],
//     guild_id: '211956704798048256',
//   },
//   {
//     type: 0,
//     tts: false,
//     timestamp: '2024-05-15T09:53:06.311000+00:00',
//     referenced_message: null,
//     pinned: false,
//     nonce: '1240240530357485568',
//     mentions: [],
//     mention_roles: [],
//     mention_everyone: false,
//     member: {
//       roles: [
//         '343304760335794177',
//         '212076668259532802',
//         '632306904466456592',
//         '524137689184862229',
//         '679862541186629659',
//       ],
//       premium_since: '2021-06-25T17:02:05.510000+00:00',
//       pending: false,
//       nick: null,
//       mute: false,
//       joined_at: '2016-08-07T21:20:16.396000+00:00',
//       flags: 2,
//       deaf: false,
//       communication_disabled_until: null,
//       avatar: null,
//     },
//     id: '1240240535890038935',
//     flags: 0,
//     embeds: [],
//     edited_timestamp: null,
//     content: '<:atoraAgony:1198793050957287475>',
//     components: [],
//     channel_id: '861845554732859404',
//     author: {
//       username: 'atorasuunva',
//       public_flags: 4588160,
//       id: '74768773940256768',
//       global_name: 'Atora',
//       discriminator: '0',
//       clan: null,
//       avatar_decoration_data: null,
//       avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//     },
//     attachments: [],
//     guild_id: '211956704798048256',
//   },
//   {
//     type: 0,
//     tts: false,
//     timestamp: '2024-05-15T09:53:11.733000+00:00',
//     sticker_items: [
//       { name: 'dapper', id: '1234966332353806416', format_type: 4 },
//     ],
//     referenced_message: null,
//     pinned: false,
//     nonce: '1240240553073836032',
//     mentions: [],
//     mention_roles: [],
//     mention_everyone: false,
//     member: {
//       roles: [
//         '343304760335794177',
//         '212076668259532802',
//         '632306904466456592',
//         '524137689184862229',
//         '679862541186629659',
//       ],
//       premium_since: '2021-06-25T17:02:05.510000+00:00',
//       pending: false,
//       nick: null,
//       mute: false,
//       joined_at: '2016-08-07T21:20:16.396000+00:00',
//       flags: 2,
//       deaf: false,
//       communication_disabled_until: null,
//       avatar: null,
//     },
//     id: '1240240558631424000',
//     flags: 0,
//     embeds: [],
//     edited_timestamp: null,
//     content: '',
//     components: [],
//     channel_id: '861845554732859404',
//     author: {
//       username: 'atorasuunva',
//       public_flags: 4588160,
//       id: '74768773940256768',
//       global_name: 'Atora',
//       discriminator: '0',
//       clan: null,
//       avatar_decoration_data: null,
//       avatar: '614b3c8468048f74b4d95d09d30f0c3f',
//     },
//     attachments: [],
//     guild_id: '211956704798048256',
//   },
// ] as unknown as APIMessage[]
